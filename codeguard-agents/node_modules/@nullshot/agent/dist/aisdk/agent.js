import { streamText, wrapLanguageModel } from 'ai';
import { isMiddlewareService } from './middleware';
import { NullShotAgent } from '../agent';
/**
 * A wrapper around the AI SDK's to support AI UI SDK and enhanced middleware support
 */
export class AiSdkAgent extends NullShotAgent {
    constructor(state, env, model, services = []) {
        super(state, env, services);
        this.middleware = [];
        this.model = model;
    }
    async initializeServices() {
        await super.initializeServices();
        for (const service of this.services) {
            // Register middleware for middleware services
            if (isMiddlewareService(service)) {
                this.middleware.push(service);
            }
        }
        // Wrap the language model with middleware if needed
        if (this.middleware.length > 0) {
            this.model = wrapLanguageModel({
                model: this.model, // Must be LanguageModelV2 object - very annoying!
                middleware: this.middleware,
            });
        }
        return Promise.resolve();
    }
    /**
     * Stream text with messages (conversation mode)
     */
    async streamTextWithMessages(sessionId, messages, options = {}) {
        const params = {
            model: this.model,
            messages,
            experimental_generateMessageId: () => `${sessionId}-${crypto.randomUUID()}`,
            ...options,
        };
        // Enrich with tools via middleware
        this.enrichParamsWithTools(params);
        // Call AI SDK v5 streamText - no casting needed!
        return streamText(params);
    }
    /**
     * Stream text with prompt (single prompt mode)
     */
    async streamTextWithPrompt(sessionId, prompt, options = {}) {
        const params = {
            model: this.model,
            prompt,
            experimental_generateMessageId: () => `${sessionId}-${crypto.randomUUID()}`,
            ...options,
        };
        // Enrich with tools via middleware
        this.enrichParamsWithTools(params);
        // Call AI SDK v5 streamText - no casting needed!
        return streamText(params);
    }
    /**
     * Common logic to enrich parameters with tools via middleware
     */
    enrichParamsWithTools(params) {
        // Apply middleware transformations for tools
        // Note: If model is a string and we have middleware, we can only apply tool transformations
        // The wrapLanguageModel middleware (wrapGenerate, wrapStream) only works with LanguageModelV2 objects
        for (const middleware of this.middleware) {
            if (middleware.transformStreamTextTools) {
                params.tools = middleware.transformStreamTextTools(params.tools);
                console.debug('Transforming tools with middleware:', middleware.name || 'unnamed');
            }
        }
    }
}
